name: Build WSL rootfs image and upload to release

on:
  workflow_dispatch:
    inputs:
      docker_image:
        description: "Docker Hub image name (example: ubuntu:noble-20251013)"
        required: true
        type: string
      release_tag:
        description: "Release tag (optional). If empty: {commit date}-{commit id (7 chars)}"
        required: false
        default: ""
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo umoci jq

      - name: Resolve build variables
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          IMAGE_INPUT="${{ github.event.inputs.docker_image }}"
          if [[ "$IMAGE_INPUT" != *":"* ]]; then
            echo "docker_image must include a tag, e.g. ubuntu:noble-20251013"
            exit 1
          fi

          IMAGE_NAME="${IMAGE_INPUT%:*}"
          IMAGE_TAG="${IMAGE_INPUT##*:}"
          IMAGE_BASENAME="${IMAGE_NAME##*/}"

          COMMIT_SHORT="$(git rev-parse --short=7 HEAD)"
          COMMIT_DATE="$(git show -s --date=format:%Y%m%d --format=%cd HEAD)"

          RELEASE_TAG_INPUT="${{ github.event.inputs.release_tag }}"
          if [[ -z "$RELEASE_TAG_INPUT" ]]; then
            RELEASE_TAG="${COMMIT_DATE}-${COMMIT_SHORT}"
          else
            RELEASE_TAG="$RELEASE_TAG_INPUT"
          fi

          OUTPUT_FILENAME="${IMAGE_BASENAME}_${IMAGE_TAG}_${COMMIT_SHORT}.tar.gz"

          echo "image_name=$IMAGE_NAME" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "commit_short=$COMMIT_SHORT" >> "$GITHUB_OUTPUT"
          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "output_filename=$OUTPUT_FILENAME" >> "$GITHUB_OUTPUT"

      - name: Build rootfs archive
        shell: bash
        run: |
          set -euo pipefail
          ./build.bash "${{ steps.vars.outputs.image_name }}" "${{ steps.vars.outputs.image_tag }}" "${{ steps.vars.outputs.commit_short }}"

      - name: Ensure release exists
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.release_tag }}"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists"
          else
            gh release create "$TAG" --title "$TAG" --notes "Automated release for $TAG"
          fi

      - name: Upload asset to release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.vars.outputs.release_tag }}"
          FILE="${HOME}/image/${{ steps.vars.outputs.output_filename }}"

          if [[ ! -f "$FILE" ]]; then
            echo "Expected file not found: $FILE"
            exit 1
          fi

          gh release upload "$TAG" "$FILE" --clobber
